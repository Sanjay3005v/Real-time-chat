<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Futuristic Chat</title>
  <link rel="stylesheet" href="style.css" />
  <script src="/socket.io/socket.io.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    .avatar-upload {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    .avatar-preview {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #00ffff;
      background: #222;
    }
    .avatar-choice {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid transparent;
      cursor: pointer;
      margin-right: 4px;
      transition: border 0.2s;
    }
    .avatar-choice.selected {
      border: 2px solid #00ffff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="users">
      <h2>🟢 Online</h2>
      <ul id="userList"></ul>
    </div>
    <div class="chat">
      <h1>
        Chat - <span id="displayName"></span>
        <button onclick="editName()">✏️</button>
        <button id="themeToggle" title="Toggle theme">🌙</button>
        <img id="avatarPreview" class="avatar-preview" src="" alt="Avatar" style="display:none; margin-left:8px;" />
      </h1>
      <div id="avatarUploadUI" class="avatar-upload" style="display:none;">
        <label>Avatar:
          <input type="file" id="avatarInput" accept="image/*" style="display:none;" />
          <button id="avatarUploadBtn">Upload</button>
        </label>
        <div id="defaultAvatars"></div>
      </div>
      <div class="chat-main">
        <ul id="messages"></ul>
        <div id="emojiBar">
          <span class="emoji">😀</span> <span class="emoji">😂</span> <span class="emoji">😍</span> <span class="emoji">😎</span> <span class="emoji">😭</span> <span class="emoji">👍</span> <span class="emoji">🙏</span> <span class="emoji">🔥</span> <span class="emoji">🎉</span> <span class="emoji">❤️</span>
          <span class="emoji">🥳</span> <span class="emoji">😡</span> <span class="emoji">😱</span> <span class="emoji">😴</span> <span class="emoji">🤔</span> <span class="emoji">😇</span> <span class="emoji">🤩</span> <span class="emoji">🥰</span> <span class="emoji">🤗</span> <span class="emoji">😜</span>
          <span class="emoji">🙌</span> <span class="emoji">👏</span> <span class="emoji">💪</span> <span class="emoji">🤝</span> <span class="emoji">👀</span> <span class="emoji">👋</span> <span class="emoji">🤷‍♂️</span> <span class="emoji">🤦‍♀️</span> <span class="emoji">💯</span> <span class="emoji">🌟</span>
        </div>
      </div>
      <div id="typingIndicator" style="min-height:22px;color:#00ffff;font-size:15px;margin:0 0 8px 0;"></div>
      <div class="input-area">
        <input id="messageInput" placeholder="Type your message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- Add modal for name and avatar selection -->
  <div id="nameAvatarModal" style="display:none;position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
    <div style="background:#181818;padding:24px 18px 18px 18px;border-radius:12px;max-width:95vw;width:340px;box-shadow:0 4px 32px #000a;text-align:center;">
      <h2 style="color:#00ffff;margin-bottom:12px;">Enter your name & choose avatar</h2>
      <input id="modalNameInput" style="width:90%;padding:10px 8px;font-size:18px;border-radius:6px;border:1px solid #00ffff44;margin-bottom:14px;" placeholder="Your name..." maxlength="24" />
      <div id="modalAvatarPreview" style="margin-bottom:10px;"></div>
      <div id="modalDefaultAvatars" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:10px;"></div>
      <input type="file" id="modalAvatarInput" accept="image/*" style="display:none;" />
      <button id="modalAvatarUploadBtn" style="margin-bottom:14px;">Upload Avatar</button><br/>
      <button id="modalConfirmBtn" style="background:#00ffff;color:#000;padding:10px 24px;font-size:18px;border:none;border-radius:6px;cursor:pointer;">OK</button>
    </div>
  </div>

  <script>
    const socket = io();
    let username = "";
    let avatarData = localStorage.getItem('avatarData') || '';

    function showAvatarUploadUI() {
      document.getElementById('avatarUploadUI').style.display = '';
      // Show preview if exists
      const preview = document.getElementById('avatarPreview');
      if (avatarData) {
        preview.src = avatarData;
        preview.style.display = '';
      } else {
        preview.style.display = 'none';
      }
    }

    function hideAvatarUploadUI() {
      document.getElementById('avatarUploadUI').style.display = 'none';
    }

    function setAvatar(data) {
      avatarData = data;
      localStorage.setItem('avatarData', data);
      const preview = document.getElementById('avatarPreview');
      if (data) {
        preview.src = data;
        preview.style.display = '';
      } else {
        preview.style.display = 'none';
      }
    }

    // Default avatars (data URLs or emoji)
    const defaultAvatars = [
      'https://api.dicebear.com/7.x/bottts/svg?seed=1',
      'https://api.dicebear.com/7.x/bottts/svg?seed=2',
      'https://api.dicebear.com/7.x/bottts/svg?seed=3',
      'https://api.dicebear.com/7.x/bottts/svg?seed=4',
      'https://api.dicebear.com/7.x/bottts/svg?seed=5',
      'https://api.dicebear.com/7.x/bottts/svg?seed=6',
    ];

    function renderDefaultAvatars() {
      const container = document.getElementById('defaultAvatars');
      container.innerHTML = '';
      defaultAvatars.forEach(url => {
        const img = document.createElement('img');
        img.src = url;
        img.className = 'avatar-choice' + (avatarData === url ? ' selected' : '');
        img.onclick = () => {
          setAvatar(url);
          renderDefaultAvatars();
        };
        container.appendChild(img);
      });
    }

    // Avatar upload logic
    const avatarInput = document.getElementById('avatarInput');
    document.getElementById('avatarUploadBtn').onclick = () => avatarInput.click();
    avatarInput.onchange = function() {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        setAvatar(e.target.result);
        renderDefaultAvatars();
      };
      reader.readAsDataURL(file);
    };

    // Modal logic for name and avatar selection
    function showNameAvatarModal(initialName, initialAvatar, onConfirm) {
      const modal = document.getElementById('nameAvatarModal');
      const nameInput = document.getElementById('modalNameInput');
      const avatarPreview = document.getElementById('modalAvatarPreview');
      const defaultAvatarsDiv = document.getElementById('modalDefaultAvatars');
      const avatarInput = document.getElementById('modalAvatarInput');
      const avatarUploadBtn = document.getElementById('modalAvatarUploadBtn');
      const confirmBtn = document.getElementById('modalConfirmBtn');

      let selectedAvatar = initialAvatar || '';
      nameInput.value = initialName || '';

      function renderPreview() {
        avatarPreview.innerHTML = selectedAvatar ? `<img src="${selectedAvatar}" style="width:48px;height:48px;border-radius:50%;border:2px solid #00ffff;background:#222;object-fit:cover;">` : '<span style="display:inline-block;width:48px;height:48px;border-radius:50%;background:#222;border:2px solid #00ffff;line-height:48px;font-size:24px;color:#00ffff;">?</span>';
      }
      function renderDefaultAvatars() {
        defaultAvatarsDiv.innerHTML = '';
        defaultAvatars.forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.className = 'avatar-choice' + (selectedAvatar === url ? ' selected' : '');
          img.style.width = '38px';
          img.style.height = '38px';
          img.onclick = () => {
            selectedAvatar = url;
            renderPreview();
            renderDefaultAvatars();
          };
          defaultAvatarsDiv.appendChild(img);
        });
      }
      renderPreview();
      renderDefaultAvatars();
      avatarUploadBtn.onclick = () => avatarInput.click();
      avatarInput.onchange = function() {
        const file = this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          selectedAvatar = e.target.result;
          renderPreview();
          renderDefaultAvatars();
        };
        reader.readAsDataURL(file);
      };
      confirmBtn.onclick = () => {
        const name = nameInput.value.trim();
        if (!name) {
          nameInput.style.borderColor = 'red';
          nameInput.focus();
          return;
        }
        if (!selectedAvatar) {
          avatarPreview.style.borderColor = 'red';
          return;
        }
        modal.style.display = 'none';
        onConfirm(name, selectedAvatar);
      };
      modal.style.display = 'flex';
    }

    // On load, show modal for name/avatar
    window.onload = () => {
      let savedName = localStorage.getItem('username') || '';
      let savedAvatar = localStorage.getItem('avatarData') || '';
      showNameAvatarModal(savedName, savedAvatar, (name, avatar) => {
        username = name;
        avatarData = avatar;
        localStorage.setItem('username', name);
        localStorage.setItem('avatarData', avatar);
        document.getElementById("displayName").textContent = username;
        setAvatar(avatarData);
        renderDefaultAvatars();
        socket.emit("new user", { username, avatar: avatarData });
        hideAvatarUploadUI();
      });
    };

    // Edit name button shows modal
    function editName() {
      showNameAvatarModal(username, avatarData, (name, avatar) => {
        username = name;
        avatarData = avatar;
        localStorage.setItem('username', name);
        localStorage.setItem('avatarData', avatar);
        document.getElementById("displayName").textContent = username;
        setAvatar(avatarData);
        renderDefaultAvatars();
        socket.emit("edit name", { username: name, avatar });
        hideAvatarUploadUI();
      });
    }

    // --- Remove all reaction-related event listeners and socket events ---
    // (Remove code for reaction click handler, socket.on('reaction update'), forceReactionUpdate, reactionUpdateInternal, etc.)

    socket.on("system message", (msg) => {
      const li = document.createElement("li");
      li.classList.add("system");
      li.textContent = msg;
      document.getElementById("messages").appendChild(li);
    });

    // --- Update avatar rendering in chat messages ---
    // --- Add reply-to-message feature ---
    let replyToMessage = null;

    function clearReplyPreview() {
      replyToMessage = null;
      const preview = document.getElementById('replyPreview');
      if (preview) preview.style.display = 'none';
    }

    function setReplyPreview(message) {
      replyToMessage = message;
      let preview = document.getElementById('replyPreview');
      if (!preview) {
        preview = document.createElement('div');
        preview.id = 'replyPreview';
        preview.className = 'reply-preview';
        document.querySelector('.input-area').insertAdjacentElement('beforebegin', preview);
      }
      preview.innerHTML = `<span class='reply-to-user'>Replying to <b>${message.username}</b>:</span> <span class='reply-to-snippet'>${message.text.slice(0, 60)}</span> <button id='cancelReplyBtn' title='Cancel reply'>&times;</button>`;
      preview.style.display = '';
      document.getElementById('cancelReplyBtn').onclick = clearReplyPreview;
    }

    // Modify chat message rendering to add reply button and render quoted message
    const messageHistory = {};
    socket.on("chat message", (msg) => {
      messageHistory[msg.id] = msg;
      const li = document.createElement("li");
      li.setAttribute("data-id", msg.id);
      if (msg.id === socket.id) li.classList.add("self");
      // Avatar
      let avatarHTML = '';
      if (msg.avatar) {
        avatarHTML = `<img class="avatar avatar-preview" src="${msg.avatar}" alt="Avatar" style="width:44px;height:44px;">`;
      } else {
        // Fallback SVG avatar
        const initials = msg.username.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
        avatarHTML = `<span class="avatar avatar-fallback" style="width:44px;height:44px;font-size:20px;">${initials}</span>`;
      }
      const timeStr = msg.time ? `<span class='msg-time'>${new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>` : '';
      // Reply block
      let replyBlock = '';
      if (msg.replyTo && messageHistory[msg.replyTo]) {
        const replied = messageHistory[msg.replyTo];
        replyBlock = `<div class='reply-block'><span class='reply-user'>${replied.username}:</span> <span class='reply-snippet'>${replied.text.slice(0, 60)}</span></div>`;
      }
      // Reply button
      const replyBtn = `<button class='reply-btn' title='Reply to this message'>↩️</button>`;
      li.innerHTML = `<div class="msg-container">${avatarHTML}<div class="msg-content">${replyBlock}<strong class="username">${msg.username}:</strong> ${msg.text} ${timeStr}</div>${replyBtn}</div>`;
      document.getElementById("messages").appendChild(li);
      li.scrollIntoView({ behavior: "smooth" });
      // Reply button event
      li.querySelector('.reply-btn').onclick = function(e) {
        setReplyPreview(msg);
        e.stopPropagation();
      };
    });

    // --- Update avatar rendering in user list ---
    socket.on("user list", (users) => {
      const list = document.getElementById("userList");
      list.innerHTML = "";
      users.forEach(user => {
        const li = document.createElement("li");
        if (user.avatar) {
          li.innerHTML = `<img class='avatar avatar-preview' src='${user.avatar}' alt='Avatar' style='width:32px;height:32px;margin-right:8px;'>` + user.username;
        } else {
          const initials = user.username.split(' ').map(w => w[0]).join('').toUpperCase().slice(0,2);
          li.innerHTML = `<span class='avatar avatar-fallback' style='width:32px;height:32px;margin-right:8px;font-size:15px;'>${initials}</span>` + user.username;
        }
        list.appendChild(li);
      });
    });

    // Update name event to also update avatar in messages
    socket.on("update name", ({ id, newName, avatar }) => {
      const messages = document.querySelectorAll(`#messages li[data-id="${id}"] .username`);
      messages.forEach(el => {
        el.textContent = `${newName}:`;
        // Update avatar if present
        if (avatar) {
          const avatarImg = el.closest('.msg-content').parentElement.querySelector('img.avatar-preview');
          if (avatarImg) avatarImg.src = avatar;
        }
      });
    });

    // --- Fix theme toggle logic ---
    const themeToggle = document.getElementById("themeToggle");
    function setTheme(theme) {
      if (theme === "light") {
        document.body.classList.add("light-theme");
        themeToggle.textContent = "☀️";
      } else {
        document.body.classList.remove("light-theme");
        themeToggle.textContent = "🌙";
      }
      localStorage.setItem("theme", theme);
    }
    themeToggle.addEventListener("click", () => {
      const current = document.body.classList.contains("light-theme") ? "light" : "dark";
      setTheme(current === "light" ? "dark" : "light");
    });
    setTheme(localStorage.getItem("theme") || "dark");

    // Remove emojiBtn, emojiPicker, and related JS
    // Add event listener for emojiBar
    const emojiBar = document.getElementById("emojiBar");
    const messageInput = document.getElementById("messageInput");
    emojiBar.addEventListener("click", (e) => {
      if (e.target.classList.contains("emoji")) {
        messageInput.value += e.target.textContent;
        messageInput.focus();
      }
    });

    // Typing indicator logic
    let typing = false;
    let typingTimeout;
    const TYPING_TIMER_LENGTH = 1200;
    const typingIndicator = document.getElementById("typingIndicator");
    messageInput.addEventListener("input", () => {
      if (!typing) {
        typing = true;
        socket.emit("typing");
      }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        typing = false;
        socket.emit("stop typing");
      }, TYPING_TIMER_LENGTH);
    });
    socket.on("typing", (name) => {
      typingIndicator.textContent = `${name} is typing...`;
    });
    socket.on("stop typing", () => {
      typingIndicator.textContent = "";
    });

    // When sending, include replyTo if set
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (text) {
        socket.emit("chat message", { text, replyTo: replyToMessage ? replyToMessage.id : null });
        input.value = "";
        clearReplyPreview();
      }
    }
    document.getElementById("sendBtn").addEventListener("click", sendMessage);
    document.getElementById("messageInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>